<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="ko">
<head>
<meta charset="utf-8">
<meta name="description" content="This is Seong-Kook Shin's personal web site.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Seong-Kook Shin's Little World (이전 포스트, 페이지 1) | Seong-Kook Shin's Little World</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS (en)" href="../../rss.xml">
<link rel="alternate" type="application/rss+xml" title="RSS (ko)" href="../rss.xml">
<link rel="canonical" href="http://www.cinsk.org/ko/blog/index-1.html">
<link rel="icon" href="../../favicon.ico" sizes="32x32">
<link rel="prev" href="index.html" type="text/html">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">주 콘텐츠로 바로가기</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://www.cinsk.org/ko/">

                <span id="blog-title">Seong-Kook Shin's Little World</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="index.html">블로그</a>
                </li>
<li>
<a href="../../cfaqs/index-ko.html">C FAQ</a>
                </li>
<li>
<a href="../archive.html">저장소</a>
                </li>
<li>
<a href="../categories/index.html">태그</a>
                </li>
<li>
<a href="../rss.xml">RSS 목록</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
            </li>
<li><a href="http://www.cinsk.org/" rel="alternate" hreflang="en">English</a></li>

                
                    
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="../posts/c-overflow-strncpy-strncat-snprintf/index.html" class="u-url">Preventing buffer overflows with strncpy, strncat, and snprintf</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Seong-Kook Shin
            </span></p>
            <p class="dateline"><a href="../posts/c-overflow-strncpy-strncat-snprintf/index.html" rel="bookmark"><time class="published dt-published" datetime="2013-02-19T19:06:00-08:00" title="2013-02-19 19:06">2013-02-19 19:06</time></a></p>
                <p class="commentline">
        
    <a href="../posts/c-overflow-strncpy-strncat-snprintf/index.html#disqus_thread" data-disqus-identifier="cache/posts/2013-02-18-c-overflow-strncpy-strnca-snprintf.ko.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Preventing Buffer overflows</h2>
<div class="outline-text-2" id="text-1">
<p>
흔히 버퍼 오퍼플로우를 막기 위해 쓰는 함수가, <code>strncpy(3)</code>, <code>strncat(3)</code>,
<code>snprintf(3)</code>⁠입니다. 이들 함수는 버퍼의 크기를 미리 지정받아, 복사할
문자열의 길이가 버퍼의 크기보다 클 경우, 복사를 중지해서 버퍼를
벗어나는 복사를 막아줍니다. 하지만, 버퍼의 크기를 해석하는 방식이
약간씩 다르다는 것이 문제입니다.
</p>

<p>
버퍼의 크기가 M이고, 복사해 넣을 문자열의 길이가 N이라고 합시다. 이 때
두 가지 경우를 생각할 수 있습니다. 첫째, 버퍼의 길이가 충분히 클 때
(즉, <code>M &gt; N</code>), 둘째 버퍼의 길이가 짧을 때 (즉 <code>M &lt; N</code>).
</p>

<p>
이 함수들을 검사하기 위해, 먼저 주어진 버퍼의 내용을 그대로 출력해 주는
함수를 만들어 봅시다. 보통 C 언어가 제공하는 문자열 함수들은 '\0'을
만나면 출력을 멈추기 때문에, 버퍼의 내용 전체를 알아 보기에는 좋지
않습니다. 따라서 다음과 같이 버퍼의 내용을 전체 다 출력해 주는 함수를
만듭니다 (필요한 표준 헤더 파일은 생략합니다):
</p>

<div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">memdump</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isprint</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="p">))</span>
      <span class="n">putchar</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="n">putchar</span><span class="p">(</span><span class="sc">'.'</span><span class="p">);</span>
    <span class="n">p</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>
예를 들어 <code>char buf[10]</code>⁠에 "ABCDEFGHI"가 들어있다고 가정하면,
<code>memdump(buf, 10)</code>⁠은 다음과 같이 출력합니다:
</p>

<div class="highlight"><pre><span></span>ABCDEFGHI.
</pre></div>

<p>
이제, 각각의 함수가 앞에서 다룬 두 가지 경우에 어떤 식으로 동작하는지
살펴봅시다. 먼저 첫번째 경우 (버퍼가 충분히 클 경우)를 알아보는 코드는
다음과 같습니다 (<code>BUF_MAX</code>⁠는 매크로이며 10입니다):
</p>

<div class="highlight"><pre><span></span><span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">'#'</span><span class="p">,</span> <span class="n">BUF_MAX</span><span class="p">);</span>
<span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"123"</span><span class="p">);</span>
<span class="n">memdump</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">BUF_MAX</span><span class="p">);</span>  <span class="n">putchar</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>

<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">'#'</span><span class="p">,</span> <span class="n">BUF_MAX</span><span class="p">);</span>
<span class="n">strncpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"123"</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="n">memdump</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">BUF_MAX</span><span class="p">);</span>  <span class="n">putchar</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>

<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">'#'</span><span class="p">,</span> <span class="n">BUF_MAX</span><span class="p">);</span>
<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<span class="n">strncat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"123"</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="n">memdump</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">BUF_MAX</span><span class="p">);</span>  <span class="n">putchar</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>

<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">'#'</span><span class="p">,</span> <span class="n">BUF_MAX</span><span class="p">);</span>
<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"%s"</span><span class="p">,</span> <span class="s">"123"</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="n">memdump</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">BUF_MAX</span><span class="p">);</span>  <span class="n">putchar</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
</pre></div>

<p>
위 코드에서 문자열 "123"을 복사해 넣으면서, 버퍼의 길이는 5라고 치고 각
함수를 테스트합니다. 이 때, 출력은 다음과 같습니다:
</p>

<div class="highlight"><pre><span></span>123.######
123..#####
123.######
123.######
</pre></div>

<p>
<code>strncpy(3)</code>⁠를 제외하고, 나머지 세 함수는 예상대로 동작합니다. 즉 문자
'1', '2', '3'을 복사해 넣고, 문자열 끝을 알리는 '\0'까지 복사합니다. 이
네 문자 모두 버퍼의 길이라고 지정한 5보다 작기 때문에 문제는 전혀
없습니다. 하지만, 두번째 줄인 <code>strncpy(3)</code>⁠는, 123을 복사해 넣고, 나머지
공간을 모두 '\0'으로 채운다는 것이 다릅니다! 즉, 버퍼가 충분히 클
경우에도, <code>strcpy(3)</code>⁠와 <code>strncpy(3)</code> 동작 방식은 서로 다릅니다!
</p>

<p>
두번째 경우, 즉 버퍼가 충분히 크지 못할 경우를 살펴 봅시다. 이제
<code>strcpy(3)</code>⁠의 경우, 테스트할 필요가 없으므로 뺐습니다:
</p>

<div class="highlight"><pre><span></span><span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">'#'</span><span class="p">,</span> <span class="n">BUF_MAX</span><span class="p">);</span>
<span class="n">strncpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"12345"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="n">memdump</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">BUF_MAX</span><span class="p">);</span>  <span class="n">putchar</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>

<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">'#'</span><span class="p">,</span> <span class="n">BUF_MAX</span><span class="p">);</span>
<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<span class="n">strncat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"12345"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="n">memdump</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">BUF_MAX</span><span class="p">);</span>  <span class="n">putchar</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>

<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">'#'</span><span class="p">,</span> <span class="n">BUF_MAX</span><span class="p">);</span>
<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">"%s"</span><span class="p">,</span> <span class="s">"12345"</span><span class="p">);</span>
<span class="n">memdump</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">BUF_MAX</span><span class="p">);</span>  <span class="n">putchar</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
</pre></div>

<p>
이 경우, 다음과 같은 출력을 얻을 수 있습니다:
</p>

<div class="highlight"><pre><span></span>123#######
123.######
12.#######
</pre></div>

<p>
세가지 함수 모두 다르게 동작한다는 것을 알 수 있습니다. 먼저
<code>strncpy(3)</code>⁠의 경우, 버퍼의 길이가 부족할 경우, 버퍼의 크기만큼 써
줍니다. 이 때 공간이 부족하더라도 '\0'을 써 주지 않습니다. 따라서
<code>strncpy(3)</code>⁠의 경우, 완전하지 못한 문자열을 얻을 수 있습니다.
</p>

<p>
<code>strncat(3)</code>⁠의 경우, 무조건 n개 문자를 복사합니다. 따라서 이 경우, 123을
복사한 다음 '\0'까지 써 줍니다. 사실 <code>strncat(3)</code>⁠의 경우, 버퍼의 길이를
지정하는 것이 아니라, '\0'을 제외한 실제 복사할 문자의 갯수를 지정하는
것입니다.
</p>

<p>
<code>snprintf(3)</code>⁠의 경우, <code>strncat(3)</code>⁠과 다르게, 버퍼의 크기를
지정합니다. 따라서 버퍼의 길이가 짧을 경우, 그 버퍼의 길이 - 1개의
문자를 복사하고, '\0'을 써 줍니다. 즉, <code>strncpy(3)</code>⁠와 다르게, 어떤
경우에도 '\0'으로 끝나는 올바른 문자열을 만들어 줍니다.
</p>

<p>
이제 이 차이를 알았으면, 실제 코드에서 어떤 식으로 써야 하는지
알아봅시다. 먼저 사용자가 입력한 문자열 some<sub>string이</sub> 있다고 가정하고,
다음 코드를 보기 바랍니다:
</p>

<div class="highlight"><pre><span></span><span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">LEN</span><span class="p">];</span>
<span class="n">strncpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">some_string</span><span class="p">,</span> <span class="n">LEN</span><span class="p">);</span>
</pre></div>

<p>
자, 위 코드는 잘못된 코드입니다. 왜냐하면 some<sub>string의</sub> 길이가 LEN보다
클 경우, buf에 들어가는 문자열이 '\0'으로 끝나지 않을 수 있기
때문입니다. 따라서 다음과 같이 써 주어야 합니다:
</p>

<div class="highlight"><pre><span></span><span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">LEN</span><span class="p">];</span>
<span class="n">strncpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">some_string</span><span class="p">,</span> <span class="n">LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">buf</span><span class="p">[</span><span class="n">LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
</pre></div>

<p>
다음 코드는 안전할까요?
</p>

<div class="highlight"><pre><span></span><span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">LEN</span><span class="p">];</span>
<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<span class="n">strncat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">some_string</span><span class="p">,</span> <span class="n">LEN</span><span class="p">);</span>
</pre></div>

<p>
아닙니다. <code>strncat(3)</code>⁠은, 버퍼의 크기가 아니라, 복사할 문자열의 길이를
지정하는 것이므로, 마찬가지로 '\0'으로 끝나지 않은 문자열을 만들
가능성이 있습니다.  이것도 다음과 같이 써야 합니다:
</p>

<div class="highlight"><pre><span></span><span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">LEN</span><span class="p">];</span>
<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<span class="n">strncat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">some_string</span><span class="p">,</span> <span class="n">LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">buf</span><span class="p">[</span><span class="n">LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
</pre></div>

<p>
그럼 <code>snprintf(3)</code>⁠를 쓴 코드를 봅시다:
</p>

<div class="highlight"><pre><span></span><span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">LEN</span><span class="p">];</span>
<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">LEN</span><span class="p">,</span> <span class="s">"%s"</span><span class="p">,</span> <span class="n">some_string</span><span class="p">);</span>
</pre></div>

<p>
위 코드는 안전할까요? 예. 그렇습니다. 안전합니다. <code>snprintf(3)</code>⁠는 버퍼의
길이를 받아서 어떤 상황에서도 '\0'으로 끝나는 완전한 문자열을 만들어
줍니다.
</p>

<p>
안전한 프로그램, buffer overflow에 항상 신경써야 하는 코드를
작성한다면, 이와 같은 사항은 꼭 기억해 두어야 합니다. 그럼 이만.
</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="../posts/c-pathmax/index.html" class="u-url">Best buffer size to store pathnames, PATH_MAX</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Seong-Kook Shin
            </span></p>
            <p class="dateline"><a href="../posts/c-pathmax/index.html" rel="bookmark"><time class="published dt-published" datetime="2013-02-18T21:40:00-08:00" title="2013-02-18 21:40">2013-02-18 21:40</time></a></p>
                <p class="commentline">
        
    <a href="../posts/c-pathmax/index.html#disqus_thread" data-disqus-identifier="cache/posts/2013-02-18-c-pathmax.ko.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Buffer size to store pathnames</h2>
<div class="outline-text-2" id="text-1">
<p>
보통 filename (또는 file name)이라고 하면 어떤 파일 이름 그 자체를
나타냅니다 (예: "hello.c" 또는 "src") 그리고 pathname이라고 하면
filename 또는 이 파일의 위치 정보까지 포함된 문자열을 뜻합니다. (예:
"<code>/usr/bin</code>", "<code>./a.out</code>", "<code>/home/cinsk/.emacs</code>" 등) 이 때 pathname은 보통
root 디렉토리에서 시작하느냐의 여부에 따라 absolute pathname
(절대경로) 또는 relative pathname (상대 경로)로 나타냅니다. Absolute
pathname의 경우, "/"로 시작하는 pathname입니다.
</p>

<p>
파일 또는 디렉토리를 다루는 프로그램을 작성하다보면, filename이나
pathname을 취급할 경우가 많은데, 이 때 주어진 pathname을 저장하기
위해, 흔히 적당히 큰 문자 배열을 준비하고 쓰는 경우가 많습니다. 이런
식으로 작성한 프로그램은 적당히 크다고 생각한 값이 별로 크지 않을
경우, 버그가 발생할 수도 있으며, 나중에 수정하기도 꽤
어렵습니다. 따라서 이 경우에는 POSIX가 정의하고 있는
<code>PATH_MAX</code>⁠란 상수를 쓰는 것이 바람직합니다.
</p>

<p>
<code>PATH_MAX</code>⁠는 패스 이름이 가질 수 있는 최대 글자 수를 나타냅니다. 패스
이름이란 디렉토리 이름을 포함한 파일 이름을 뜻합니다. (예:
"<code>/usr/bin/ls</code>", "<code>/opt/share/info</code>"). 문자열의 끝을 나타내는 '<code>\0</code>'도
포함입니다. 따라서 정확히 파일이 가질 수 있는 글자 수의 총 길이는
<code>PATH_MAX - 1</code>⁠이 됩니다.
</p>

<p>
따라서 파일 이름을 처리하거나 저장할 경우, <code>PATH_MAX</code>⁠ 크기의 메모리
공간을 준비해 놓고 작업하면 됩니다. 예를 들면 다음과 같습니다:
</p>

<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">foo</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
  <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>     
  <span class="n">strncpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pathname</span><span class="p">,</span> <span class="n">PATH_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

  <span class="p">...</span>
<span class="p">}</span>
</pre></div>

<p>
인생이 이렇게 단순했으면 얼마나 좋겠습니까만… 사실 이게 전부가 아닙니다.
</p>

<p>
먼저, POSIX 호환 시스템이라 하더라도 <code>PATH_MAX</code>⁠가 정의되어 있지 않은
경우가 있습니다.  왜 정의가 되어 있지 않냐면, 파일 이름의 길이 제한이
파일 시스템마다 달라질 수 있기 때문입니다.  예를 들어 무조건 한 파일
시스템만 사용하는 OS나, 여러 파일 시스템을 지원하더라도 파일 길이
제한의 값이 같은 OS라면 <code>PATH_MAX</code>⁠가 정의되어 있습니다. 하지만, 만약 여러
파일 시스템을 지원하고, 또 각 파일 시스템마다 지원하는 최대 파일 이름
길이가 다르다면, 단순히 한 상수로 최대 파일 이름 길이를 나타낼 수
없습니다.
</p>

<p>
또한, 드물지만, 파일 이름 길이에 제한이 없다면, <code>PATH_MAX</code>⁠가 정의되어
있지 않습니다.
</p>

<p>
둘째, <code>PATH_MAX</code>⁠가 정의되어 있다 하더라도, 이 매크로가 배열의 크기로
쓰기에는 너무나 큰 상수일 가능성이 있습니다. 따라서 다음과 같이, 배열의
크기를 지정하는 목적으로 <code>PATH_MAX</code>⁠를 쓰는 것은 별로 바람직한 방법은
아닙니다. (저도 여유가 없으면 자주 쓰는 방식이긴 하지만.. -_-;;)
</p>

<div class="highlight"><pre><span></span><span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
</pre></div>

<p>
세째, <code>PATH_MAX</code>⁠의 정확한 뜻에 관한 것입니다.  <code>PATH_MAX</code>⁠는 임의의 한
pathname이 가질 수 있는 최대 값을 나타내는 것이 아닙니다. 다시 말해,
<code>PATH_MAX</code>⁠보다 큰 pathname이 존재할 수도 있습니다. 여기에 관한 것은 바로
뒤에 pathconf(3)를 설명할 때 다루겠습니다.
</p>

<p>
그럼 <code>PATH_MAX</code>⁠가 정의되어 있지 않다면 어떻게 pathname의 최대값을 얻을 수
있느냐? 답은 pathconf(3)나 fpathconf(3)를 쓰는 것입니다.
</p>

<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">long</span> <span class="nf">fpathconf</span><span class="p">(</span><span class="n">itn</span> <span class="n">filedes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">name</span><span class="p">);</span>
<span class="kt">long</span> <span class="nf">pathconf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">name</span><span class="p">);</span>
</pre></div>

<p>
두 함수 모두, pathname에 관련된 정보를 얻는 목적으로 쓰이며,
fpathconf()는 이미 열려있는 file descriptor를, pathconf()는
파일/디렉토리 이름을 첫 인자로 받습니다. <code>PATH_MAX</code>⁠의 값을 얻으려면 두
함수 모두 두번째 인자에 <code>_PC_PATH_MAX</code>⁠를 주면 됩니다.
</p>

<p>
왜 file descriptor나 파일/디렉토리 이름이 필요한지 궁금해 하는 분도
있을 것입니다. 그 이유는, 앞에서 잠깐 말했듯이, pathname의 최대값은
현재 파일 시스템에 따라 달라질 수 있기 때문에, 기준이 되는
파일/디렉토리 이름이 필요하기 때문입니다.
</p>

<p>
이 두 함수 모두, 다른 정보를 얻기 위해 사용되기도 합니다. 예를 들어,
단순한 파일 이름의 최대값을 얻으려면 위 함수의 두번째 인자로
<code>_PC_NAME_MAX</code>⁠를 사용합니다. 또 주어진 파일이 pipe (또는 FIFO)인 경우,
파이프 버퍼의 크기를 얻기 위해 <code>_PC_PIPE_BUF</code>⁠를 쓸 수도 있습니다.
</p>

<p>
한가지 주의할 것은 이 때 얻은 <code>PATH_MAX</code>⁠ 값의 정확한 뜻입니다. 두 번째
인자로 <code>_PC_PATH_MAX</code>⁠를 쓸 경우, 첫 번째 인자로 전달한 파일 이름이나
file descriptor는 반드시 디렉토리에 대한 이름 또는 file
descriptor이어야 합니다. 첫 번째 인자가 디렉토리를 가르킬 경우, 이 때
리턴한 값은 주어진 디렉토리를 기준으로한 상대 경로가 가질 수 있는 최대
길이를 뜻합니다. 만약 첫번째 인자가 디렉토리를 가리키지 않는다면, 리턴
값과 주어진 파일과 어떤 관계가 있다는 것을 보장할 수 없습니다. 또한
pathname의 길이에 대한 제한이 없는 경우, 이 두 함수는 -1을 리턴하고
errno를 설정하지 않습니다.
</p>

<p>
추가적으로, POSIX는 <code>_POSIX_PATH_MAX</code>⁠란 매크로를 256으로 정의하고
있습니다. 그리고 <code>PATH_MAX</code>⁠는 적어도 <code>_POSIX_PATH_MAX</code>⁠와 같거나 큰 값을
가져야한다고 정의합니다. 또 오래된 유닉스 시스템은 전통적으로
MAXPATHLEN이란 매크로를 쓰는 경우가 많습니다. (주의, 필자는
MAXPATHLEN의 정확한 뜻이나 유래에 대해 잘 모릅니다. 아시는 분은 제게
알려주시면 고맙겠습니다.)
</p>

<p>
또, ISO C 표준은 파일 이름을 저장하기 위한 배열의 크기를 지정할
목적으로 <code>FILENAME_MAX</code>⁠란 매크로를 <code>&lt;stdio.h&gt;</code>⁠에 정의하고 있습니다. 이
매크로는 배열을 선언할 때 쓸 목적으로 만든 것이기 때문에 다음과 같이
쓰는 것이 가능합니다:
</p>

<div class="highlight"><pre><span></span><span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">FILENAME_MAX</span><span class="p">];</span>
</pre></div>

<p>
하지만, 사용가능한 파일의 최대 길이가 제한이 없는 경우라면, 문자 배열의
크기로 쓸만한 값을 <code>FILENAME_MAX</code>⁠로 정의한다고 나와 있습니다. 따라서
파일의 최대 길이가 제한이 없는 경우라면 pathconf()나 fpathconf()를
써야만 알 수 있습니다. (errno 변경없이 -1을 리턴)
</p>

<p>
따라서 이식성이 뛰어난 프로그램을 만들고 싶다면 다음과 같은 코드를 헤더
파일에 포함시키는 것도 좋을 것입니다:
</p>

<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;limits.h&gt;</span><span class="cp"></span>

<span class="cp">#ifndef _POSIX_PATH_MAX</span>
<span class="cp">#define _POSIX_PATH_MAX    256</span>
<span class="cp">#endif</span>

<span class="cp">#if !defined =PATH_MAX=  &amp;&amp; defined _PC_PATH_MAX</span>
<span class="cp"># define PATH_MAX    (pathconf("/", _PC_PATH_MAX) &lt; 1 ? 1024 \</span>
<span class="cp">		      : pathconf("/", _PC_PATH_MAX))</span>
<span class="cp">#endif</span>

<span class="cp">#if !defined PATH_MAX &amp;&amp; defined MAXPATHLEN</span>
<span class="cp"># define PATH_MAX MAXPATHLEN</span>
<span class="cp">#endif</span>

<span class="cp">#if !defined PATH_MAX &amp;&amp; defined FILENAME_MAX</span>
<span class="cp"># define PATH_MAX FILENAME_MAX</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef PATH_MAX</span>
<span class="cp"># define PATH_MAX _POSIX_PATH_MAX</span>
<span class="cp">#endif</span>
</pre></div>

<p>
물론 완벽한 것은 아닙니다. 사실 위 코드는 gnulib 패키지의 &lt;pathmax.h&gt;를
조금 손본 것이며, pathname 길이에 제한이 없는 경우는 고려하지
않았습니다.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Summary</h2>
<div class="outline-text-2" id="text-2">
<p>
지금까지 내용을 요약해 보면,
</p>

<ol class="org-ol">
<li>pathname을 저장하기 위해, <code>PATH_MAX</code>⁠를 쓰는 것은 바람직하나,
<code>PATH_MAX</code>⁠보다 큰 pathname이 존재할 수도 있다는 것.
</li>
<li>
<code>PATH_MAX</code>⁠를 쓸 경우, 동적으로 메모리를 할당하는 방식 (예: malloc()
함수)을 쓰는 것이 바람직하다는 것.
</li>
<li>
<code>PATH_MAX</code>⁠는 마지막 '\0'도 포함한다는 것. 즉 <code>PATH_MAX</code>⁠ + 1과 같은
형태로 쓸 필요가 없다는 것.
</li>
<li>
<code>PATH_MAX</code>⁠가 정의되어 있지 않을 경우, pathconf(3) 또는 fpathconf(3)를
써서 <code>PATH_MAX</code>⁠의 값을 얻을 수 있다는 것.
</li>
<li>세번째 목적으로 pathconf(3)나 fpatconf(3)를 쓸 때, 첫번째 인자는
디렉토리를 가리키고 있어야 한다는 것입니다.
</li>
</ol>
<p>
마지막으로, <code>FILENAME_MAX</code>⁠를 제외한 모든 매크로, 함수는 SUS 표준
(POSIX)이며, ISO C 표준에는 나와 있지 않다는 것을 말해 둡니다.
</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="../posts/screen-parallel-execution/index.html" class="u-url">Parallel commands execution using GNU screen</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Seong-Kook Shin
            </span></p>
            <p class="dateline"><a href="../posts/screen-parallel-execution/index.html" rel="bookmark"><time class="published dt-published" datetime="2012-12-04T00:00:00-08:00" title="2012-12-04 00:00">2012-12-04 00:00</time></a></p>
                <p class="commentline">
        
    <a href="../posts/screen-parallel-execution/index.html#disqus_thread" data-disqus-identifier="cache/posts/2012-12-04-screen-parallel.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <p>
I have been working on to develop large-scale web application, which
deals with a lot of image files. To test the application, we need a
huge number of large (the resolution should be higher than 640x480)
images. Since we didn't have lots of samples, I decided to grab from
<a href="http://images.google.com/">http://images.google.com/</a>. For my own execuse, the testing will be
done in private network, which makes me less obligation for the
copyright issue.
</p>

<p>
The image archiving job was simple. I create a small shell script that
extracts actual image URL from the saved Google images result, and
saved that file as images.lst. Each line of that file contains image
URL. Then I create another script that reads URL one by one, and <a href="http://www.gnu.org/software/wget">wget</a>
the image to the local storage, and produce several thumbnails using
<a href="http://www.imagemagick.org/">ImageMagick</a>. So the whole process can be describe as:
</p>

<div class="highlight"><pre><span></span>$ cat images.lst <span class="p">|</span> ./image-downloader.sh
</pre></div>

<p>
I intended to download around 1000 images, and since it uses just one
thread of execution, it will takes for a while. At that time, I was
beginning to wonder, "It would be great if there is an utility that
automatically divide the input data file into specified number of
pieces, then execute the command that I specified for each piece."
</p>

<p>
I instantly remembered that there is a tool called <a href="http://www.gnu.org/software/parallel/">parallel</a>, but I
decided to make my own. There is a reason to build from scratch:
</p>

<p>
The work job program, which will deal with dividened piece, is not
matured program mostly. This means that I need to watch the progress
of each job process output, and I need to fix it in quick-and-dirty
way.  Similar to previous reason, sometimes, I need to analyze the
output of the process at the run-time.  Needs a 'detatched from tty'
feature, so that I can launch the whole process in remote and can
forget it for a while.  All the reasons makes me to think, it would be
great if I can create a script (I named it, screen-parallel.sh) to use
GNU screen to do the parallel jobs. For example, if I specified the
concurrency level to 10, then screen-parallel.sh will divide the input
into 10 pieces, and will create 10 screen windows, and execute the
command that I specified per piece.
</p>

<p>
For example, in the beginning of the article, I used 
"<code>cat images.lst | ./image-downloader.sh</code>". To do that job in 10 workers,
</p>

<div class="highlight"><pre><span></span>$ screen-parallel.sh -h
Parallel execution of a <span class="nb">command</span> using GNU screen<span class="o">(</span><span class="m">1</span><span class="o">)</span>
Usage: screen-parallel.sh <span class="o">[</span>OPTION...<span class="o">]</span> COMMAND <span class="o">[</span>ARG...<span class="o">]</span>

    -c CONCURRENCY           <span class="nb">set</span> concurrency level <span class="o">(</span>default: <span class="m">3</span><span class="o">)</span>

    -i INPUT                 specify input data file
    -p                       send input to STDIN of COMMAND

    -d                       leave screen<span class="o">(</span><span class="m">1</span><span class="o">)</span> in detached state.

    -v                       verbose mode

If no input file specified, this program will create CONCURRENCY
windows, <span class="k">then</span> each window will execute COMMAND with ARGs.

Otherwise, input file will be splitted in CONCURRENCY parts, and
COMMAND will be executed per part.  If any of ARG is <span class="s2">"{}"</span>, <span class="k">then</span> it
will be substituted to the pathname of the part.  If there is none,
the pathname of the part will be appended to ARGs.

Example:

    <span class="c1"># Split 'input.txt into 5 parts,</span>
    <span class="c1"># and execute "./process.sh -i PART-PATHNAME -v".</span>
    screen-parallel.sh -i input.txt -c <span class="m">5</span> ./process.sh -i <span class="o">{}</span> -v

    <span class="c1"># Run 3 instances of "standalone.sh -p"</span>
    screen-parallel.sh -c <span class="m">3</span> ./standalone.sh -p

$ screen-parallel.sh -c <span class="m">10</span> -i images.lst -p ./image-downloader.sh
</pre></div>

<p>
Option <code>-c 10</code> means to specify the concurrency level to 10, and option
<code>-i images.lst</code> means to use the input file, <code>images.lst</code>, and option <code>-p</code>
indicates that the each divided piece will be provides via STDIN to
the command process.
</p>

<p>
The whole source code is provided in the <a href="https://github.com/cinsk/screen-parallel/">GitHub repository</a>. Feel free
to leave an issue there if you have any comment or suggestion. Thanks.
</p>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="../posts/couchdb-register-design/index.html" class="u-url">A tool for registering CouchDB design documents, couch-register-design</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Seong-Kook Shin
            </span></p>
            <p class="dateline"><a href="../posts/couchdb-register-design/index.html" rel="bookmark"><time class="published dt-published" datetime="2012-11-11T00:00:00-08:00" title="2012-11-11 00:00">2012-11-11 00:00</time></a></p>
                <p class="commentline">
        
    <a href="../posts/couchdb-register-design/index.html#disqus_thread" data-disqus-identifier="cache/posts/2012-11-11-couch-register-design.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <p>
Whenever I experiment CouchDB, especially design documents, always I
feel unhandy to upload the document.
</p>

<p>
For simple experiments, Futon (CouchDB web interface) is the easiest
solution. However, if you want to keep the changes systemically, or
if you want to use any version control system, you're on your own.
</p>

<p>
The difficulty come from the format of the design document; CouchDB
wants you to specify javascript functions in JSON string. If you
decided not to use Futon, you'll escape your function in JSON string
by yourself.
</p>

<p>
Worse, if your function is not valid, you'll realize after the
design document is uploaded.
</p>

<p>
Precisely, I want a tool that:
</p>

<ul class="org-ul">
<li>can add/update the design document from the sources that I provided,
</li>
<li>can verify all javascript functions before uploading,
</li>
<li>can upload attachment files.
</li>
</ul>
<p>
First, I tried to use CouchApp, but lack of the detailed guide makes
me gave up. Sorry CouchApp folks. :(
</p>

<p>
Second, I wrote simple bash shell scripts to interact with CouchDB
with <code>curl(1)</code>, to upload the document after escaping the function to
build JSON document. It was not simple to implement all the features
that I need, so I stopped.
</p>

<p>
Third, I try to write the tool in Ruby, and try to use httpclient,
but I couldn't make httpclient works for HTTP client features like
multipart/form-data. (Mayhaps I didn't know how to use httpclient
fluently.) So I stopped again.
</p>

<p>
Fourth, I realized that I spent too much time to write this
script. I don't want to dig the source of the httpclient, so I just
write small Ruby wrapper of <code>curl(1)</code>, and made the tool, finally.
</p>

<p>
If you have interest, visit couch-register-design and experiment.
</p>

<div class="highlight"><pre><span></span>$ ./register-designs.rb -h
Usage: register-designs.rb <span class="o">[</span>OPTION...<span class="o">]</span> DIRECTORY

    -d, --database <span class="o">[</span>URL<span class="o">]</span>             CouchDB endpoint URL
				     <span class="o">(</span>default: <span class="s2">"http://localhost:5984/sedis"</span><span class="o">)</span>

    -j, --jspath <span class="o">[</span>JS-PATH<span class="o">]</span>           Javascript interpreter
    -v, --verbose                    Verbose output

    -h, --help                       Show this message
    -V, --version                    Show version and <span class="nb">exit</span>

Register design documents from DIRECTORY where it contains
files <span class="k">for</span> the document.

  DIRECTORY/views/VIEW-NAME/*.js  <span class="o">(</span>e.g. map.js or reduce.js<span class="o">)</span>
  DIRECTORY/shows/*.js            <span class="o">(</span>e.g. print.js or others<span class="o">)</span>
  DIRECTORY/*.js                  <span class="o">(</span>e.g. validate_doc_update.js<span class="o">)</span>
  DIRCETORY/_attachments/*        <span class="o">(</span>automatically uploaded<span class="o">)</span>

Report bugs to &lt;cinsky at gmail.com&gt; or post bugs to
  &lt;https://github.com/cinsk/couch-register-design/issues&gt;
</pre></div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="../posts/emacs-mail-address-completion/index.html" class="u-url">Emacs Mail Address Completion</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Seong-Kook Shin
            </span></p>
            <p class="dateline"><a href="../posts/emacs-mail-address-completion/index.html" rel="bookmark"><time class="published dt-published" datetime="2012-10-16T00:00:00-08:00" title="2012-10-16 00:00">2012-10-16 00:00</time></a></p>
                <p class="commentline">
        
    <a href="../posts/emacs-mail-address-completion/index.html#disqus_thread" data-disqus-identifier="cache/posts/2012-10-16-emacs-mail-address-completion.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <p>
I don't use Emacs for reading mails. All of my mail servers uses IMAP,
and for productivity, Emacs as a mail client is too slow. It's kind of
sad.  However, sending e-mail in Emacs (M-x mail) speed up my daily
work greatly. Normally, I discuss some code within Emacs, and for the
reference, I send the code fragment or org file to the
discussioners. ('discussioner' is not an English word. I don't know
any word for it.)
</p>

<p>
The problem is, I usually don't remember mail address for
people. Had I used graphical mail agent such as thunderbird or
outlook, I would be pleased to see the auto-completion feature of
them. But no such luck in Emacs. (Yes I know there are couple of
Emacs packages that analyze mail boxes to extract the mail
addresses, but none makes me comfortable enough. Those who want it
anyway, see <a href="http://bbdb.sourceforge.net/">BBDB</a>)
</p>

<p>
All I want is, to use my gmail contacts as address completing
candidates.
</p>

<p>
So I wrote very simple Ruby script, to extract the contact
information from my gmail account, and save it as contacts.el using
following command:
</p>

<div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nv">$HOME</span>/.emacs.d
$ ./gcontact.el MY-GMAIL-ACCOUNT@gmail.com
password: ********
$ _
</pre></div>

<p>
Then add following code to your init script:
</p>

<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span> <span class="nv">complete-contact-address-internal</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">name</span> <span class="p">(</span><span class="nf">completing-read</span> <span class="s">"address: "</span>
			       <span class="nv">my-google-contacts</span>
			       <span class="nv">nil</span> <span class="ss">'confirm</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">string-match</span> <span class="s">"@"</span> <span class="nv">name</span><span class="p">)</span>
	<span class="nv">name</span>
      <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">found</span> <span class="p">(</span><span class="nb">assoc </span><span class="nv">name</span> <span class="nv">my-google-contacts</span><span class="p">))</span>
	    <span class="p">(</span><span class="nf">nam</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">string-match</span> <span class="s">"\\(.*?\\) *([^)]*) *$"</span> <span class="nv">name</span><span class="p">)</span>
		     <span class="p">(</span><span class="nf">match-string</span> <span class="mi">1</span> <span class="nv">name</span><span class="p">)</span>
		   <span class="nv">name</span><span class="p">)))</span>
	<span class="p">(</span><span class="nf">format</span> <span class="s">"%s &lt;%s&gt;"</span> <span class="nv">nam</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">found</span><span class="p">))))))</span>

<span class="p">(</span><span class="nf">defun</span> <span class="nv">complete-contact-address</span> <span class="p">(</span><span class="nf">&amp;optional</span> <span class="nv">arg</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">interactive</span> <span class="s">"P"</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">address</span> <span class="p">(</span><span class="nf">complete-contact-address-internal</span><span class="p">))</span>
	<span class="p">(</span><span class="nf">pos</span> <span class="p">(</span><span class="nf">point</span><span class="p">)))</span>
    <span class="p">(</span><span class="nf">save-restriction</span>
      <span class="p">(</span><span class="nf">save-match-data</span>
	<span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">point-min</span><span class="p">))</span>
	<span class="p">(</span><span class="nf">re-search-forward</span> <span class="p">(</span><span class="nf">regexp-quote</span> <span class="nv">mail-header-separator</span><span class="p">)</span>
			   <span class="p">(</span><span class="nf">point-max</span><span class="p">)</span> <span class="nv">t</span><span class="p">)</span>
	<span class="p">(</span><span class="nf">beginning-of-line</span><span class="p">)</span>
	<span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">header-sep</span> <span class="p">(</span><span class="nf">point</span><span class="p">)))</span>
	  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt;= </span><span class="nv">pos</span> <span class="nv">header-sep</span><span class="p">)</span>
	      <span class="p">(</span><span class="nf">progn</span>
		<span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">point-min</span><span class="p">))</span>
		<span class="p">(</span><span class="nf">re-search-forward</span> <span class="s">"^To:"</span> <span class="nv">header-sep</span> <span class="nv">t</span><span class="p">))</span>
	    <span class="p">(</span><span class="nf">goto-char</span> <span class="nv">pos</span><span class="p">))</span>
	  <span class="p">(</span><span class="nf">beginning-of-line</span><span class="p">)</span>
	  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="k">or </span><span class="p">(</span><span class="nf">re-search-forward</span> <span class="s">"^[^[:blank:]][^:]*:[[:blank:]]*$"</span>
				     <span class="p">(</span><span class="nf">line-end-position</span><span class="p">)</span> <span class="nv">t</span><span class="p">)</span>
		  <span class="p">(</span><span class="nf">re-search-forward</span> <span class="s">"^[[:blank:]]+$"</span> <span class="p">(</span><span class="nf">line-end-position</span><span class="p">)</span> <span class="nv">t</span><span class="p">))</span>
	      <span class="p">(</span><span class="nf">insert</span> <span class="nv">address</span><span class="p">)</span>
	    <span class="p">(</span><span class="nf">beginning-of-line</span><span class="p">)</span>
	    <span class="p">(</span><span class="nf">re-search-forward</span> <span class="s">"[,[:blank:]]*$"</span> <span class="p">(</span><span class="nf">line-end-position</span><span class="p">)</span> <span class="nv">t</span><span class="p">)</span>
	    <span class="p">(</span><span class="nf">replace-match</span> <span class="p">(</span><span class="nf">format</span> <span class="s">", %s"</span> <span class="nv">address</span><span class="p">))))))))</span>

<span class="p">(</span><span class="nf">eval-after-load</span> <span class="s">"sendmail"</span>
  <span class="o">'</span><span class="p">(</span><span class="nv">progn</span>
     <span class="p">(</span><span class="nf">define-key</span> <span class="nv">mail-mode-map</span> <span class="p">[(</span><span class="nf">meta</span> <span class="nv">return</span><span class="p">)]</span> <span class="ss">'complete-contact-address</span><span class="p">)</span>

     <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">contacts</span> <span class="p">(</span><span class="nf">concat</span> <span class="p">(</span><span class="nf">file-name-as-directory</span> <span class="nv">user-emacs-directory</span><span class="p">)</span>
			     <span class="s">"contacts.el"</span><span class="p">)))</span>
       <span class="p">(</span><span class="nf">when</span> <span class="p">(</span><span class="nf">file-exists-p</span> <span class="nv">contacts</span><span class="p">)</span>
	 <span class="p">(</span><span class="nf">load-file</span> <span class="nv">contacts</span><span class="p">)))))</span>    
</pre></div>

<p>
When writing e-mail in Emacs using M-x mail, press M-RET to
auto-completing mail address.
</p>

<p>
<img src="../../images/emacs-mail-address-completion.png" alt="Emacs mail address completion"></p>

<p>
Listing of gcontract.rb:
</p>

<script src="http://gist-it.appspot.com/github/cinsk/emacs-scripts/raw/master/gcontact.rb"></script>
</div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="../posts/bash-wait-tcp-port.org/index.html" class="u-url">Wait until TCP port opened using bash and nc</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Seong-Kook Shin
            </span></p>
            <p class="dateline"><a href="../posts/bash-wait-tcp-port.org/index.html" rel="bookmark"><time class="published dt-published" datetime="2012-09-23T00:00:00-08:00" title="2012-09-23 00:00">2012-09-23 00:00</time></a></p>
                <p class="commentline">
        
    <a href="../posts/bash-wait-tcp-port.org/index.html#disqus_thread" data-disqus-identifier="cache/posts/2012-09-23-bash-wait-tcp-port.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <p>
Recently, I wrote a shell script which interacts with a TCP
server. Since the script took charge of launching the server,
sometimes my script fails because the server did not open the socket
yet.
</p>

<p>
To come up with this problem, I used to wait certain amount of time
using <code>sleep(1)</code> like this:
</p>

<div class="highlight"><pre><span></span><span class="c1"># launch the server which automatically daemonizes itself.</span>
start-server 

<span class="c1"># one second is enough for my system.</span>
sleep <span class="m">1</span>

client <span class="k">do</span> something
</pre></div>

<p>
It was fine for my system, until I realized this method would not
work on slow machine. Worse, when my system in a heavy-load, my
system also failed to run above script successfully.
</p>

<p>
I would solve this problem by raising the amount of seconds
sleeping, but I do not want to wait more on my relatively fast
system.
</p>

<p>
Then I realized that netcat (a.k.a. <code>nc</code>) provides such feature with
the "-z" option.
</p>

<p>
To test whether <code>www.cinsk.org</code> (TCP port 80) is opened, I can launch
</p>

<div class="highlight"><pre><span></span><span class="c1"># In BSD-like (MacOS) system</span>
$ nc -z www.cinsk.org <span class="m">80</span>
Connection to www.cinsk.org <span class="m">80</span> port <span class="o">[</span>tcp/http<span class="o">]</span> succeeded!
$ _

<span class="c1"># On my Linux system, no message but just return zero on success</span>
$ nc -z www.cinsk.org <span class="m">80</span>
$ _
</pre></div>

<p>
Then I found another problem. Suppose that the firewall drops all
packets for that port. Since by default, netcat(<code>nc</code>) will wait
permanently until the port is open, the script that uses netcat(<code>nc</code>)
will not return.
</p>

<p>
Thanks to the rich interface of netcat, it provides another option
"-w" to specify the amount of time it will wait. The problem is,
MacOS nc (BSD) does not work with "-w" option if the firewall drops
all packets. Installing GNU version will solve this problem. (by the
command "<code>brew install netcat</code>")
</p>

<p>
Finally, I wrote wait4tcp.sh to lessen the burden for others.
</p>

<div class="highlight"><pre><span></span><span class="c1"># Wait until port 80 8080 5984 are opened</span>
$ ./wait4tcp.sh HOSTNAME <span class="m">80</span> <span class="m">8080</span> <span class="m">5984</span>

<span class="c1"># The same as above, except it will retry only 10 times per each port.</span>
$ ./wait4tcp.sh -w <span class="m">10</span> HOSTNAME <span class="m">80</span> <span class="m">8080</span> <span class="m">5984</span>

<span class="c1"># Wait until port 80 is closed</span>
$ ./wait4tcp.sh -c HOSTNAME <span class="m">80</span>

<span class="c1"># The same as above, except it will retry permanently.</span>
$ ./wait4tcp.sh -w -1 -c HOSTNAME <span class="m">80</span>

<span class="c1"># With the bash brace expansion, wait for port range 6379..6383 are opened</span>
$ ./wait4tcp.sh HOSTNAME <span class="o">{</span><span class="m">6379</span>..6383<span class="o">}</span>
</pre></div>

<p>
By default, wait4tcp.sh will retry 100 times per each port. Retrying
100 times is done less than 1 second in my system. Using "-w -1"
option will retry permanently.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Updated</h2>
<div class="outline-text-2" id="text-1">
<p>
Recently, I read valuable article from <a href="http://www.catonmat.net/blog/tcp-port-scanner-in-bash/">TCP Port Scanner in Bash</a>,
and found that bash provides special filenames for redirections.
</p>

<p>
As Peteris suggested, I changed to bash special filenames and
<code>timeout(1)</code> so that there is no dependency to netcat(<code>nc</code>).
</p>

<p>
Here is the full source code for <code>wait4tcp.sh</code>:
</p>

<script src="https://gist.github.com/3769111.js"> </script>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="../posts/emacs-ruby-rvm-prompt/index.html" class="u-url">Emacs ruby-mode and RVM propmt</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Seong-Kook Shin
            </span></p>
            <p class="dateline"><a href="../posts/emacs-ruby-rvm-prompt/index.html" rel="bookmark"><time class="published dt-published" datetime="2012-08-31T00:00:00-08:00" title="2012-08-31 00:00">2012-08-31 00:00</time></a></p>
                <p class="commentline">
        
    <a href="../posts/emacs-ruby-rvm-prompt/index.html#disqus_thread" data-disqus-identifier="cache/posts/2012-08-31-emacs-ruby-rvm-prompt.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <p>
On emacs ruby-mode, if you do <code>M-x run-ruby</code> (or
<code>C-c C-s</code>), the inferior ruby interpreter is provided in
the "<code>*ruby*</code>" buffer so that you can evaluate lots of ruby
statements or expressions.
</p>

<p>
When you press <code>M-p</code> (<code>M-x comint-previous-input</code>), Emacs will cycle to
the previous input histrory saving input, so that you can easily
re-evaulate of your previous input.
</p>

<p>
It works like other inferior interpreter provided by python-mode,
slime, and so on.
</p>

<p>
What makes me frustrated is, it works for the ruby 1.8 installed in
my gentoo system, but it does not work for the ruby 1.9.3 installed
via RVM. The minibuffer shows sulpurous error:
</p>

<div class="highlight"><pre><span></span><span class="no">Search</span> <span class="ss">failed</span><span class="p">:</span> <span class="s2">"^irb(.*)[0-9:]+0&gt; *"</span>
</pre></div>

<p>
Looking at the ruby-mode's source, I found that string is the value
of '<code>inferior-ruby-first-prompt-pattern</code>' in <code>inf-ruby.el</code>. It looks
like that ruby-mode uses <code>inferior-ruby-first-prompt-pattern</code> and
<code>inferior-ruby-prompt-pattern</code> for the ruby's prompt pattern.
</p>

<p>
Another notable different from the start between two rubies (v1.8
system versus v1.9 RVM) are their prompt patterns:
</p>

<div class="highlight"><pre><span></span><span class="c1"># ruby 1.8 (system)</span>
<span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">001</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">_</span>

<span class="c1"># ruby 1.9.3 (RVM)</span>
<span class="n">ruby</span><span class="o">-</span><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">2</span><span class="o">-</span><span class="n">p180</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="n">_</span>
</pre></div>

<p>
Now it's clear who is the culprit. Due to the difference of the
prompt pattern, ruby-mode could not provide me <code>M-p</code> or <code>M-n</code> working.
</p>

<p>
So I modified two variables in <code>inf-ruby.el</code> and reports a bug to the
Ruby issue tracking system and got a quick response.
</p>

<p>
It turns out that it's not the fault of ruby-mode, but it's the
fault of RVM. (Actually, it's not a defect. It just not right for my
purpose.)
</p>

<p>
By default, RVM uses different prompt from the native ruby. To solve
this, you can force RVM ruby (irb) to use the native prompt
pattern. It's simple: modify <code>$HOME/.irbrc</code> to include following:
</p>

<div class="highlight"><pre><span></span><span class="no">IRB</span><span class="o">.</span><span class="n">conf</span><span class="o">[</span><span class="ss">:PROMPT_MODE</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:DEFAULT</span>
</pre></div>

<p>
I feel embbarassed that I blamed ruby-mode when I found something is
wrong :(
</p>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="../posts/emacs-darwin-fontset/index.html" class="u-url">OS X Emacs 24.1 Fontset revised</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Seong-Kook Shin
            </span></p>
            <p class="dateline"><a href="../posts/emacs-darwin-fontset/index.html" rel="bookmark"><time class="published dt-published" datetime="2012-07-10T00:00:00-08:00" title="2012-07-10 00:00">2012-07-10 00:00</time></a></p>
                <p class="commentline">
        
    <a href="../posts/emacs-darwin-fontset/index.html#disqus_thread" data-disqus-identifier="cache/posts/2012-07-10-emacs-darwin-fontset.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <p>
Whenever I installed new Emacs version, the init script for fontset
turned out not working.  It is sad that even now Emacs fontset related API is somewhat
unstable. I cannot blame Emacs developers for this. Part of the
reason is there are so many bad font (esp. Korean font) which works
very poorly on non-Windows machines.
</p>

<p>
Anyway, the script in <a href="file:///posts/emacs-smart-ediff/index.html">my previous post</a> does not work with the stable
24.1 binary from <a href="http://emacsformacosx.com/">EmacsForMacOsX</a>.
</p>

<p>
Here are working version of Emacs snippet that uses different font
for multiple charset:
</p>

<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">when</span> <span class="p">(</span><span class="nf">eq</span> <span class="nv">system-type</span> <span class="ss">'darwin</span><span class="p">)</span>
  <span class="c1">;; These configuration seems to work in</span>
  <span class="c1">;; GNU Emacs 24.1.1 (x86_64-apple-darwin, NS apple-appkit-1038.36)</span>
  <span class="c1">;; of 2012-06-11 on bob.porkrind.org</span>

  <span class="c1">;; default font family</span>
  <span class="p">(</span><span class="nf">set-face-attribute</span> <span class="ss">'default</span> <span class="nv">nil</span> <span class="nv">:family</span> <span class="s">"Consolas"</span><span class="p">)</span>

  <span class="c1">;; default font size</span>
  <span class="c1">;;</span>
  <span class="c1">;; WARNING: depending on the default font, some height value may</span>
  <span class="c1">;; cause a broken frame display; that is, the beginning of the </span>
  <span class="c1">;; buffer is not visible.</span>
  <span class="p">(</span><span class="nf">set-face-attribute</span> <span class="ss">'default</span> <span class="nv">nil</span> <span class="nv">:height</span> <span class="mi">165</span><span class="p">)</span>

  <span class="c1">;; You may add :size POINT in below font-spec if you want to use</span>
  <span class="c1">;; specific size of Hangul font regardless of default font size</span>
  <span class="p">(</span><span class="nf">set-fontset-font</span> <span class="nv">t</span> <span class="ss">'hangul</span>
		    <span class="p">(</span><span class="nf">font-spec</span> <span class="nv">:name</span> <span class="s">"NanumGothicCoding"</span><span class="p">)))</span>
</pre></div>

<p>
Height 165 seems to work well with "Consolas" font.
</p>

<p>
Yes! The height is 165 (about 16 pt). As I'm growing old, I cannot
use smaller font size any more. It sucks! Anyway, here is the
screenshot with the above setting:
</p>

<p>
[[<img src="../../images/emacs-darwin-fontset.png" alt="nil">]
</p>

<p>
I tried with several fonts such as Monaco, Andale Mono, and so on
but I found Consolas is superior among others (this is my biased
opinion, of course.)
</p>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="../posts/emacs-smart-ediff/index.html" class="u-url">Smart ediff widen frame on Emacs</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Seong-Kook Shin
            </span></p>
            <p class="dateline"><a href="../posts/emacs-smart-ediff/index.html" rel="bookmark"><time class="published dt-published" datetime="2012-04-26T00:00:00-08:00" title="2012-04-26 00:00">2012-04-26 00:00</time></a></p>
                <p class="commentline">
        
    <a href="../posts/emacs-smart-ediff/index.html#disqus_thread" data-disqus-identifier="cache/posts/2012-04-26-emacs-smart-ediff.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <p>
One of the reason that I love Emacs is the ediff package, which
provides nice diff interface that I cannot find similar feature in
other editors. Here are some screenshots of sample ediff session:
</p>

<p>
<img src="../../images/ediff-1.png" alt="Ediff Example 1"><img src="../../images/ediff-2.png" alt="Ediff Example 2"></p>

<p>
The first one (on left-side) uses the default split, called
<i>vertical split</i>, and the second one (on the right-side) is called
<i>horizontal split</i>. You can switch back and force using <code>|</code> or <code>M-x
ediff-toggle-split</code> command in the ediff control buffer. As you can
see here, the horizontal split looks much more readable. One
problem, though. Normally, I uses 80 character width for a emacs
frame. If I choose to use the horizontal split, it automatically
split the windows in the 80-char-width frame, so that each window
will have about 40 characters. (Actually, depending on the width of
the scroll bar and the internal borders, it will be smaller than 40
characters).
</p>

<p>
Around a couple of years ago, I wrote custom hook function to
automatically widen the frame on the "horizontal split" and restore
to the original frame width when ediff session finished. What makes
me to feel stupid is, Ediff has already provided that feature years
ago. If you use <code>m</code> or <code>M-x ediff-toggle-wide-display</code> on the ediff
control buffer, the frame width will span to that of the display.
</p>

<p>
One problem is, I use two LCD minitor, combined into one X display
(using nvidia's TwinView feature). Each monitor supports 1920x1080,
so my X window system provides 3840x1080 display. That means, if I
call <code>ediff-toggle-wide-display</code>, the screen will look like:
</p>

<p>
<img src="../../images/ediff-widen-display.png" alt="Ediff Wide Display"></p>

<p>
As you can see, this is unacceptable. So, again, I need to modify
the configuration little bit, so that it will widen the frame in a
reasonable amount.
</p>

<p>
Let's find out which code should be modified. On the ediff control
buffer, <code>C-h k m</code> shows that the <code>m</code> command is binded to
<code>ediff-toggle-wide-display</code> in <code>ediff-util.el</code>. After reading the
function code, <code>ediff-toggle-wide-display</code> will call the function in
the value of <code>ediff-make-wide-display-function</code>, which is set to
<code>ediff-make-wide-display</code> by default. This means that, if I write my
own function that does the job of <code>ediff-make-wide-display</code>, problem
will be solved! Yeah~
</p>

<p>
But what makes me troubled is, it is not straight-forward to
determine the 'reasonable amount of frame width. Several ideas come
up to my mind:
</p>

<ul class="org-ul">
<li>Normally, most people prefer 80 character width for a window. What
about <code>80 * 2 = 160</code> for the widened frame? — No, using hard-coded
value is always a bad choice.
</li>
<li>Each buffer can have its own <code>fill-column</code> value, which is 70 by
default. What about to use <code>fill-column * 2</code>? — No, probably using
the previous width of the windows is the better.
</li>
<li>Ediff provides 2 way diff or 3 way diff job. Merely doubling the
width is not good. Depending 2-way-diff or 3-way-diff, I might
need to multiply by two or by three.
</li>
<li>In any case, user might want to use specific width. It will be
handy, if <code>m</code> command can have prefix value for the exact width of
the window. For example, <code>160m</code> will set window width to 160, so
that total frame width will be <code>160 * 2 = 320</code> character width.
</li>
</ul>
<p>
To provide the prefix value, I need to wrap the
<code>ediff-toggle-wide-display</code> with my own advice function:
</p>

<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defadvice</span> <span class="nv">ediff-toggle-wide-display</span> <span class="p">(</span><span class="nf">around</span> <span class="nv">cinsk/ad-ediff-toggle-wide-display</span>
					     <span class="p">())</span>
  <span class="p">(</span><span class="nf">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">w</span> <span class="p">(</span><span class="nf">prefix-numeric-value</span> <span class="nv">current-prefix-arg</span><span class="p">))</span>
	<span class="p">(</span><span class="nf">min-width</span> <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="nf">window-live-p</span> <span class="nv">ediff-window-A</span><span class="p">)</span>
			  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">eq</span> <span class="nv">ediff-split-window-function</span> 
				  <span class="ss">'split-window-vertically</span><span class="p">)</span>
			      <span class="c1">;; ediff windows splitted like A/B</span>
			      <span class="p">(</span><span class="nf">window-width</span> <span class="nv">ediff-window-A</span><span class="p">)</span>
			    <span class="c1">;; ediff windows splitted like A|B</span>
			    <span class="p">(</span><span class="nf">frame-width</span> <span class="p">(</span><span class="nf">window-frame</span> <span class="nv">ediff-window-A</span><span class="p">))))</span>
			 <span class="p">((</span><span class="nf">buffer-live-p</span> <span class="nv">ediff-buffer-A</span><span class="p">)</span>
			  <span class="p">(</span><span class="nf">buffer-local-value</span> <span class="ss">'fill-column</span>
					      <span class="nv">ediff-buffer-A</span><span class="p">))</span>
			 <span class="p">(</span><span class="nf">t</span> <span class="p">(</span><span class="nb">max </span><span class="nv">fill-column</span> <span class="mi">70</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nf">setq</span> <span class="nv">w</span> <span class="p">(</span><span class="nb">max </span><span class="nv">min-width</span> <span class="nv">w</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">message</span> <span class="s">"width: %S"</span> <span class="nv">w</span><span class="p">)</span>

    <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">cinsk/ediff-wide-window-width</span> <span class="nv">w</span><span class="p">))</span>
      <span class="nv">ad-do-it</span><span class="p">)))</span>

<span class="p">(</span><span class="nf">ad-activate</span> <span class="ss">'ediff-toggle-wide-display</span><span class="p">)</span>
</pre></div>

<p>
Since advice function cannot change the function interface of the
advised function, I'm not sure if I can use <code>current-prefix-arg</code> in
the advice function like above. One more bad design is, above code
relies on the dynamic binding of the local variable,
<code>cinsk/ediff-wide-window-width</code>. Anyway it works as I expected. :)
</p>

<p>
For the <code>ediff-make-wide-display-function</code>, I'll use following
function instead of genuine one:
</p>

<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span> <span class="nv">cinsk/ediff-make-wide-display</span> <span class="p">()</span>
  <span class="s">"Construct an alist of parameters for the wide display.</span>
<span class="s">Saves the old frame parameters in `ediff-wide-display-orig-parameters'.</span>
<span class="s">The frame to be resized is kept in `ediff-wide-display-frame'.</span>
<span class="s">This function modifies only the left margin and the width of the display.</span>
<span class="s">It assumes that it is called from within the control buffer."</span>
  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nf">fboundp</span> <span class="ss">'ediff-display-pixel-width</span><span class="p">))</span>
      <span class="p">(</span><span class="nf">error</span> <span class="s">"Can't determine display width"</span><span class="p">))</span>
  <span class="p">(</span><span class="k">let* </span><span class="p">((</span><span class="nf">frame-A</span> <span class="p">(</span><span class="nf">window-frame</span> <span class="nv">ediff-window-A</span><span class="p">))</span>
  <span class="p">(</span><span class="nf">frame-A-params</span> <span class="p">(</span><span class="nf">frame-parameters</span> <span class="nv">frame-A</span><span class="p">))</span>
	 <span class="p">(</span><span class="nf">fw</span> <span class="p">(</span><span class="nf">frame-width</span> <span class="nv">frame-A</span><span class="p">))</span>
	 <span class="p">(</span><span class="nf">fpw</span> <span class="p">(</span><span class="nf">frame-pixel-width</span> <span class="nv">frame-A</span><span class="p">))</span>
  <span class="p">(</span><span class="nf">cw</span> <span class="p">(</span><span class="nf">ediff-frame-char-width</span> <span class="nv">frame-A</span><span class="p">))</span>
	 <span class="p">(</span><span class="nf">febw</span> <span class="nv">cw</span><span class="p">)</span>                      <span class="c1">; frame external border width</span>
	 <span class="p">(</span><span class="nf">fibw</span> <span class="p">(</span><span class="nb">- </span><span class="nv">fpw</span> <span class="p">(</span><span class="nb">* </span><span class="nv">fw</span> <span class="nv">cw</span><span class="p">)))</span>       <span class="c1">; frame internal border width</span>
	 <span class="nv">desired-fw</span> <span class="nv">desired-fpw</span> <span class="nv">desired-left</span><span class="p">)</span>

    <span class="p">(</span><span class="nf">setq</span> <span class="nv">ediff-wide-display-orig-parameters</span>
   <span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="nb">cons </span><span class="ss">'left</span> <span class="p">(</span><span class="nb">max </span><span class="mi">0</span> <span class="p">(</span><span class="nb">eval </span><span class="p">(</span><span class="nb">cdr </span><span class="p">(</span><span class="nb">assoc </span><span class="ss">'left</span> <span class="nv">frame-A-params</span><span class="p">)))))</span>
  <span class="p">(</span><span class="nb">cons </span><span class="ss">'width</span> <span class="p">(</span><span class="nb">cdr </span><span class="p">(</span><span class="nb">assoc </span><span class="ss">'width</span> <span class="nv">frame-A-params</span><span class="p">))))</span>
   <span class="nv">ediff-wide-display-frame</span> <span class="nv">frame-A</span><span class="p">)</span>

    <span class="p">(</span><span class="nf">setq</span> <span class="nv">desired-fw</span> <span class="p">(</span><span class="nb">* </span><span class="nv">cinsk/ediff-wide-window-width</span>
			<span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="k">and </span><span class="p">(</span><span class="nf">boundp</span> <span class="ss">'ediff-3way-job</span><span class="p">)</span> <span class="nv">ediff-3way-job</span><span class="p">)</span>
			    <span class="mi">3</span> <span class="mi">2</span><span class="p">)))</span>

    <span class="c1">;; ensure that DESIRED-FW is smaller than the screen size</span>
    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nb">* </span><span class="nv">desired-fw</span> <span class="nv">cw</span><span class="p">)</span> <span class="nv">febw</span> <span class="nv">fibw</span><span class="p">)</span> <span class="p">(</span><span class="nf">ediff-display-pixel-width</span><span class="p">))</span>
	<span class="p">(</span><span class="nf">setq</span> <span class="nv">desired-fw</span> <span class="p">(</span><span class="nb">/ </span><span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nf">ediff-display-pixel-width</span><span class="p">)</span> <span class="nv">fibw</span> <span class="nv">febw</span><span class="p">)</span> <span class="nv">cw</span><span class="p">)))</span>

    <span class="c1">;;(setq desired-fpw (+ (* desired-fw cw) fbw))</span>
    <span class="p">(</span><span class="nf">setq</span> <span class="nv">desired-fpw</span> <span class="p">(</span><span class="nb">* </span><span class="nv">desired-fw</span> <span class="nv">cw</span><span class="p">))</span>
    <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">left</span> <span class="p">(</span><span class="nb">eval </span><span class="p">(</span><span class="nb">cdr </span><span class="p">(</span><span class="nb">assoc </span><span class="ss">'left</span> <span class="nv">frame-A-params</span><span class="p">)))))</span>
      <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="nf">eq</span> <span class="nv">cinsk/ediff-wide-display-policy</span> <span class="ss">'left</span><span class="p">)</span>
	     <span class="p">(</span><span class="nf">setq</span> <span class="nv">desired-left</span> <span class="p">(</span><span class="nb">- </span><span class="nv">left</span> <span class="p">(</span><span class="nb">* </span><span class="p">(</span><span class="nb">- </span><span class="nv">desired-fw</span> <span class="nv">fw</span><span class="p">)</span> <span class="nv">cw</span><span class="p">))))</span>

	    <span class="p">((</span><span class="nf">eq</span> <span class="nv">cinsk/ediff-wide-display-policy</span> <span class="ss">'right</span><span class="p">)</span>
	     <span class="p">(</span><span class="nf">setq</span> <span class="nv">desired-left</span> <span class="nv">left</span><span class="p">))</span>

	    <span class="p">(</span><span class="nf">t</span>                          <span class="c1">; center</span>
	     <span class="p">(</span><span class="nf">setq</span> <span class="nv">desired-left</span> <span class="p">(</span><span class="nb">- </span><span class="nv">left</span> <span class="p">(</span><span class="nb">/ </span><span class="p">(</span><span class="nb">* </span><span class="p">(</span><span class="nb">- </span><span class="nv">desired-fw</span> <span class="nv">fw</span><span class="p">)</span> <span class="nv">cw</span><span class="p">)</span> <span class="mi">2</span><span class="p">)))))</span>

      <span class="c1">;; ensure that the frame will be inside of the display border.</span>
      <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&lt; </span><span class="p">(</span><span class="nb">- </span><span class="nv">desired-left</span> <span class="p">(</span><span class="nb">/ </span><span class="nv">febw</span> <span class="mi">2</span><span class="p">))</span> <span class="mi">0</span><span class="p">)</span>
	  <span class="p">(</span><span class="nf">setq</span> <span class="nv">desired-left</span> <span class="p">(</span><span class="nb">/ </span><span class="nv">febw</span> <span class="mi">2</span><span class="p">)))</span>

      <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="p">(</span><span class="nb">+ </span><span class="nv">desired-left</span> <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nb">* </span><span class="nv">desired-fw</span> <span class="nv">cw</span><span class="p">)</span> <span class="nv">fibw</span> <span class="p">(</span><span class="nb">/ </span><span class="nv">febw</span> <span class="mi">2</span><span class="p">)))</span>
	     <span class="p">(</span><span class="nf">ediff-display-pixel-width</span><span class="p">))</span>
	  <span class="p">(</span><span class="nf">setq</span> <span class="nv">desired-left</span> <span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nf">ediff-display-pixel-width</span><span class="p">)</span> 
				<span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nb">* </span><span class="nv">desired-fw</span> <span class="nv">cw</span><span class="p">)</span> <span class="nv">fibw</span> <span class="p">(</span><span class="nb">/ </span><span class="nv">febw</span> <span class="mi">2</span><span class="p">))))))</span>

    <span class="c1">;; (message "resizing WIDTH to %S where LEFT to %S" desired-fw desired-left)</span>

    <span class="p">(</span><span class="nf">modify-frame-parameters</span>
     <span class="nv">frame-A</span> <span class="o">`</span><span class="p">((</span><span class="nf">left</span> <span class="o">.</span> <span class="o">,</span><span class="nv">desired-left</span><span class="p">)</span> <span class="p">(</span><span class="nf">width</span> <span class="o">.</span> <span class="o">,</span><span class="nv">desired-fw</span><span class="p">)</span>
	       <span class="p">(</span><span class="nf">user-position</span> <span class="o">.</span> <span class="nv">t</span><span class="p">)))))</span>
</pre></div>

<p>
Of course, I need to set <code>ediff-make-wide-display-function</code> before
loading ediff module, so put below line in front of the init file:
</p>

<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">setq</span> <span class="nv">ediff-make-wide-display-function</span> <span class="ss">'cinsk/ediff-make-wide-display</span><span class="p">)</span>
<span class="p">(</span><span class="nf">require</span> <span class="ss">'ediff</span><span class="p">)</span>
</pre></div>

<p>
And if you want to restore to the previous frame configuration on
ediff exit, add following code:
</p>

<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">add-hook</span> <span class="ss">'ediff-quit-hook</span>
	      <span class="p">(</span><span class="k">lambda </span><span class="p">()</span>
		<span class="p">(</span><span class="k">if </span><span class="nv">ediff-wide-display-p</span>
		    <span class="ss">'ediff-toggle-wide-display</span><span class="p">)))</span>
</pre></div>

<p>
You may also want to register above function <code>(lambda () ...)</code> in
<code>ediff-suspend-hook</code> if you want to restore the frame on ediff
suspension.
</p>

<p>
If you want full source, check out my <a href="https://github.com/cinsk/emacs-scripts/blob/master/snippets/ediff.el">github repository</a>.
</p>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="../posts/emacs-mac-fontset/index.html" class="u-url">Emacs, Mac, Fontset, Font and X resources</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Seong-Kook Shin
            </span></p>
            <p class="dateline"><a href="../posts/emacs-mac-fontset/index.html" rel="bookmark"><time class="published dt-published" datetime="2012-04-05T00:00:00-08:00" title="2012-04-05 00:00">2012-04-05 00:00</time></a></p>
                <p class="commentline">
        
    <a href="../posts/emacs-mac-fontset/index.html#disqus_thread" data-disqus-identifier="cache/posts/2012-04-05-emacs-mac-fontset.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <p>
Recently, I bought a macbook pro for my personal use.
As soon as it is delivered to my home, I installed Emacs 24.x, from
<a href="http://emacsformacosx.com/">EmacsForMacOsX</a>.  Normally, in my other computers, I use the version
23.x.  The reason that I installed unstable 24.x is, that I want to
use the package system (package.el) in my macbook.  It would be very
boring and tedious if I need to install all the packages that I want
to use like in my other Gentoo linux.
</p>

<p>
For my Linux systems, I uses Korean and English fonts using Emacs's
X resource configuration.  For example,
</p>

<div class="highlight"><pre><span></span>Emacs*Fontset-0:-*-DejaVu Sans Mono-*-*-*-*-14-*-*-*-*-*-fontset-dejavu14,\
	  latin:-*-DejaVu Sans Mono-*-*-*-*-14-*-*-*-*-*-*,\
	hangul:-*-NanumGothic_Coding-*-*-*-*-*-*-*-*-*-*-*
Emacs.Font: fontset-dejavu14
</pre></div>

<p>
But in my macbook, it didn't work. The reason is, in Mac, the X
window system is not running by default. It seems that MacOS delays
loading X window system until the first X application starts. And it
takes a couple of seconds, which I don't like it. Of course, I could
force to load the X resource, by using <code>xrdb -merge
MY_EMACS_X_RESOURCE_FILE</code> in my <code>.bash_profile</code> but as I said
before, it took several seconds to load the X system.
</p>

<p>
So, I want to set my fontset configuration in the startup lisp code
instead X resource file. With a few experiments, here are the
working version:
</p>

<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">set-fontset-font</span> <span class="s">"fontset-standard"</span> <span class="ss">'unicode</span> 
		  <span class="p">(</span><span class="nf">font-spec</span> <span class="nv">:name</span> <span class="s">"Consolas"</span>
			     <span class="nv">:weight</span> <span class="ss">'normal</span>
			     <span class="nv">:slant</span> <span class="ss">'normal</span>
			     <span class="nv">:size</span> <span class="mi">16</span><span class="p">))</span><span class="c1">; nil 'prepend)</span>
<span class="p">(</span><span class="nf">set-fontset-font</span> <span class="s">"fontset-standard"</span> <span class="ss">'hangul</span>
		  <span class="p">(</span><span class="nf">font-spec</span> <span class="nv">:name</span> <span class="s">"NanumGothicCoding"</span><span class="p">))</span>

<span class="p">(</span><span class="nf">set-face-font</span> <span class="ss">'default</span> <span class="s">"fontset-standard"</span><span class="p">)</span>
</pre></div>

<p>
In addition to fontset configuration, there are a few more configuration for Mac.
</p>

<ol class="org-ol">
<li>I want to use Command key as a meta key, since it's where the
Meta key should be.
</li>
<li>I want to use Command-C to work as "copy the content to the
clipboard".  Since the Command key is meta key now, I want to
bind M-c to something that works like "copy the selection to the
clipboard for other application.".
</li>
<li>I want to make Fn-Delete key as to delete right character.
</li>
<li>I want to maintain one startup lisp code for all my Linux
machines and Macbook.
</li>
</ol>
<p>
With some help, here's the complete lisp code for Mac:
</p>

<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">when</span> <span class="p">(</span><span class="nf">eq</span> <span class="nv">system-type</span> <span class="ss">'darwin</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">setq</span> <span class="nv">mac-option-modifier</span> <span class="nv">nil</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">setq</span> <span class="nv">mac-command-modifier</span> <span class="ss">'meta</span><span class="p">)</span>
  <span class="c1">;; sets fn-delete to be right-delete</span>
  <span class="p">(</span><span class="nf">global-set-key</span> <span class="p">[</span><span class="nv">kp-delete</span><span class="p">]</span> <span class="ss">'delete-char</span><span class="p">)</span>

  <span class="p">(</span><span class="nf">set-fontset-font</span> <span class="s">"fontset-standard"</span> <span class="ss">'unicode</span> 
		    <span class="p">(</span><span class="nf">font-spec</span> <span class="nv">:name</span> <span class="s">"Consolas"</span>
			       <span class="nv">:weight</span> <span class="ss">'normal</span>
			       <span class="nv">:slant</span> <span class="ss">'normal</span>
			       <span class="nv">:size</span> <span class="mi">16</span><span class="p">))</span><span class="c1">; nil 'prepend)</span>
  <span class="p">(</span><span class="nf">set-fontset-font</span> <span class="s">"fontset-standard"</span> <span class="ss">'hangul</span>
		    <span class="p">(</span><span class="nf">font-spec</span> <span class="nv">:name</span> <span class="s">"NanumGothicCoding"</span><span class="p">))</span>

  <span class="p">(</span><span class="nf">set-face-font</span> <span class="ss">'default</span> <span class="s">"fontset-standard"</span><span class="p">)</span>

  <span class="p">(</span><span class="nf">when</span> <span class="p">(</span><span class="nf">display-graphic-p</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">global-set-key</span> <span class="p">[(</span><span class="nf">meta</span> <span class="nv">?c</span><span class="p">)]</span> <span class="ss">'ns-copy-including-secondary</span><span class="p">)))</span>
</pre></div>

<p>
Finally! I can use Emacs with my custom preferences like in my Linux
machines. :)
</p>

<p>
Note that this configuration worked on Emacs pretest binary 24.x
EmacsForMacOsX. As 24.1 is turned to the stable release, it suddenly
turned out not working! :(  Read on more <a href="../../2012/07/10/osx-emacs-fontset.html">here</a>.
</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index.html" rel="prev">최신 포스트</a>
            </li>
        </ul></nav><script>var disqus_shortname="cinsk";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2018         <a href="mailto:cinsky%20at%20gmail.com">Seong-Kook Shin</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><script src="../../assets/js/colorbox-i18n/jquery.colorbox-kr.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("ko");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
